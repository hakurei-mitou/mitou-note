# 计算机网络

本笔记仅记录少量要点和技巧，主要看书。

## 杂项

- 可引入数学方法计算极值最值等。 王道P11.1
- 报文流与字节流的差别
	- 在报文流中，网络要区分报文的边界，但在字节流中，网络不必区分这样的边界。
- 存储容量或数据大小：$2^{10}$；传输速度通信速度：$10^3$ 。
- 在以太网上，广播帧可以被所有站接收到，包括发送站。 王道P113.18
- 路由器由于互联多个网络，因此有多个 IP 地址和多个硬件地址（MAC）。 王道P151
- 注意，对于一个 IP 地址，若没有带斜线记法的 CIDR，则要考虑是 IPv4 的几类地址还是 CIDR。
- **下一跳**有时是指路由器的名字，有时候是其某个端口的 IP 地址。
- 常见协议端口总结 王道P266

## 计算机网络体系结构

- 按网络范围分类
	- 广域网（WAN）
		- 使用交换技术。 王道P4
		- 采用网状拓扑结构。
	- 城域网（MAN）
		- 采用以太网技术。
	- 局域网（LAN）
		- 使用广播技术。
	- 个人区域网（PAN）
	
- 性能指标 王道P6

  - 带宽的基本单位是比特每秒 bit/s
  - 电路交换在中途不会进行存储转发，只在一开始发送一次。 王道 P8.4
  - $k$ 段链路，采用存储转发，在 $n$ 个分组的发送过程中，从第 $k$ 个分组开始会有连续 $n$ 个分组到达，从而总的传输时延为 $(k-1) + n$ 倍的传输时延。传播时延不这样考虑，直接 $k$ 倍即可。
  - 注意开始分组和结束分组的各种时间消耗。 王道 P9.6
  - 画**分组发送简图**时，来回的分组按时间增加方向画折线（左右竖线，中间“折线”（斜线））。
  - 中间结点不包括开始结点和终点，所以为链路数减一（$n-1$）。

- 计算机网络分层结构 王道P12

	- 概念

		- 服务数据单元（SDU）
		- 协议控制单元（PCI）
		- 协议数据单元（PDU）
		- 服务访问点（SAP）

	- 最低层只提供服务，最上层面向用户提供服务。

	- 只有能被上一层观测到的功能才能叫服务。

	- OSI 参考模型

	  - 会话层可通过校验点实现通信恢复和数据同步。
	  - ISO/OIS 模型的网络层支持无连接和面向连接的通信，但传输层只支持面向连接的通信。
	  - TCP/IP 模型的网络层只有无连接通信，传输层支持无连接和有连接通信。

	- TCP/IP 模型

	- 综合五层模型

	- 第 $0$ 层（物理媒体）

	- 数据链路层分为:

		- 逻辑链路控制子层（LLC）
		- 介质访问控制子层（又称媒体接入控制子层）（MAC）
	
	- **复用**
	
	  汇聚到主机外部（向低层流动）。
	
	- **分用**
	
	  放射到主机内部（向高层流动）。
	
	- 拥塞控制
	
	  网络层和传输层才有。
	
	- 流量控制
	
	  可以存在于数据链路层及以上各层中，但各层控制的对象不一定。
	
	  目前提供流量控制的主要是数据链路层、网络层、传输层。
	
	- 物理层不存在下一层，所以不封装数据。
	
	- 端到端
	
	  只有传输层及以上各层的通信才能叫端到端。
	
	- PDU
	
	  - 传输层：报文段（TCP）、用户数据报（UDP）
	  - 网络层：分组、数据报
	  - 数据链路层：帧
	  - 物理层：比特
	
	- 低层的可靠传输并不能保证高层的可靠传输。 王道P131

## 物理层

### 基本概念

- 码元

	$1$ 码元可以携带若干比特的信息量。

- 信道

	信道是信号传输的媒介，一条通信线路往往包含一条发送信道和一条接收信道。

- 数据率

	单位时间内传递的数据量。

	- 码元传输速率（波特率）
		- 单位时间内传输的**码元**个数，单位为**波特（Baud）**，即**码元每秒**。
	- 信息传输速率（信息速率，比特率）
		- 单位时间内传输的**二进制码元**个数，即**比特数**（有效比特数），单位比特每秒。

### 两大定理

王道P32

- 奈奎斯特定理（奈氏准则）
  - 无噪声环境
  - $极限码元传输速率 = 2W$，（$W$ 为带宽）
  - $极限数据传输速率 = 2W\log_2V$，（$V$ 为一码元离散电平的数目，$\log_2V$是一码元的比特数）
- 香农定理
  - 有噪声环境
  - $极限数据传输速率 = W\log_2(1+{S\over N}) = W\log_2(1+10^{分贝数\over 10})$。
  - 信号的平均功率与噪声的平均功率之比，$信噪比 = 10\log_{10}({S \over N})$，单位 dB 。
- 注意，若给出了**码元包含的比特数关系**（即说明了编码方式），则综合考虑两个定理，取较小的那个结果。王道P41.15

### 编码与调制

- 区分

  - 编码

    变为数字信号。

  - 调制

    变为模拟信号。

- 数字数据编码为数字信号

  - 曼彻斯特编码
    - 看中间跳变（位中间的跳变也作为时钟信号）
    
    - 以太网即使用曼彻斯特编码。
    
    - **注意**
    
    	- **曼彻斯特和差分曼彻斯特**的**波特率**是**比特率**（有效比特率）的**两倍**。王道P46.10
    
    		因为用了两位（应有四个状态）来编码一比特（有两个状态），有两个状态未使用，从而导致这个反直觉的现象。4B/5B 编码也同理。
    
  - 差分曼彻斯特编码
    - 开始有跳变为 $0$ 。

  - 共同点
    - 每个码元中间都有一次跳变。
    
  - 区分
    
    - 先以差分曼看位开始表示的信号是否前后矛盾。 王道P44.40
    - 不是差分曼则是曼。
    
  - 4B/5B 编码

    四位数据一组，编码为一个四位码，再附加一位作为控制信息位，

    一个码元 $4$ 比特数据。数据率 $80\%$ 。

- 数字数据调制为模拟信号

  - 调幅
  - 调频
  - 调相
  - 正交振幅调制（QAM） 王道P34
    - $数据传输速率\ R = B\log_2(mn)$，单位 b/s
    - 其中 $B$ 为波特率，$m$ 个相位，每个相位 $n$ 种振幅。（$\log_2(mn)$ 就是一码元的比特数）


- 模拟数据编码为数字信号

	- 脉码调制（PCM，脉冲编码调制）（针对音频信号）
	
	- 采样
	
	     - 采样定理（又称奈奎斯特定理）
	
	          采样频率必须大于等于原始信号最大频率的两倍 $f_{采样} \ge 2f_{原始最大}$ 。
	
	          才能保证采样后的数字信号完全保留模拟信号的信息。
	
	          - 模拟信号的频率要考虑采样定理 王道P41.22
	
	- 量化
	
	- 编码

- 模拟数据调制为模拟信号

	- 使用频分复用，将模拟数据加载到载波模拟信号上。

### 交换方式

- 电路交换

	电路交换不具备差错控制能力，不能保证无差错传输。（不“智能”）

- 报文交换

- 分组交换

  - 数据报方式
  - 虚电路方式

  	- 建立，传输，释放。
  	- 虚电路号，虚电路表、
  	- 提供可靠通信，具有流量控制功能。
  	- 分组顺序到达。
  	- 分组首部不含目的地址，包含虚电路标识符。
  	- 虚电路既有临时性服务，也有永久性服务。

  - 注意，分组交换含有两种方式，虚电路方式和数据报方式，要分清层次。 王道P43.32

### 传输介质

- 双绞线

	- 屏蔽双绞线（STP）
	- 非屏蔽双绞线（UTP）

- 距离太远时

	- 对于模拟信号，使用放大器。（放大）
	- 对于数字信号，使用中继器。（整形再生）

- 光纤

	- 多模光纤
		- 适合近距离传输。

	- 单模光纤
		- 适合远距离传输。

- 无线介质

	- 无线电波

		穿透力强，长距离。

	- 微波、红外线、激光

- 物理层接口的特性

	- 机械特性

	- 电气特性

		电压范围。

	- 功能特性

		电压的某一电平的含义。（数字信号才有电平）

	- 过程特性（规程特性）

		不同功能的可能事件的出现顺序。

### 物理层设备

- 中继器（转发器）

	- 中继器不能连接速率不同的局域网。

	- 数字信号（整形再生）

	- 串联的中继器不能超过 $4$ 个。

	- 5-4-3 规则

		五段通信介质中，即 $4$ 个中继器串联时，只有 $3$ 个网段可以挂接计算机。

- 放大器

	- 模拟信号（放大）

- 集线器（hub）

	- 对信号进行整形放大。
	- 实质上是一个多端口的中继器。
	- 从一个端口入，从其余所有端口出。
	- 如果有两个或多个端口输入，会发生冲突，所有数据失效。
	- 不能划分冲突域。

- 区分对比 王道P59

	- 三个传输
		- 基带传输
		
			将基带信号直接传送到线路（信道）上。

		- 频带传输
		
			将基带信号调制后传送到线路（信道）上。
		
		- 宽带传输
		
			借助频带传输，从而可以将链路划分为多个信道，每个信道可以传送不同的信号，称为宽带传输。
		
	- 同步与异步
		- 同步通信
		- 异步通信

### 杂项

- 10 BaseT 即 10M/s 的以太网，采用曼彻斯特编码。


 - 二进制信号一码元就是一比特。
    - 时分复用要求以最高数据率的支路为准，对其它低于该数据率的支路进行脉冲填充，使其速率一致。假设时分复用八路，则是将八路复用入一秒内，数据率要乘以八。王道P41.22
 - 如果某个设备具有存储转发功能，那么可以连接不同速率的网段和不同的协议，如果没有，则不能。
    - 物理层互联成功只需要两个网段速率相同。
 - 数据链路层互联成功，需要网段速率和协议都相同。


## 数据链路层

### 基本概念

- 为网络层提供服务

  - 无确认无连接服务

  	- 适用于实时通信或误码率较低的信道，如以太网。

  - 有确认无连接服务

  	- 超时重传
  	- 适用于误码率较高的信道，如无线通信。

  - 有确认有连接服务

  	适用于通信要求高的场合。

  - 有连接一定有确认，没有无确认有连接的服务。

- 数据链路层协议都规定了**帧的数据部分长度上限——最大传送单元（MTU）**。

- 功能概述

  - 帧定界

  	确定帧的边界。

  - 帧同步

  	从比特流中区分帧的起始与终止。

  - 透明传输

  	对于数据中含有与定界符相同的字符时的处理。

  - 流量控制

  	- 限制发送方的数据流量，使接收方来得及接收。

  	- 控制相邻两结点链路上的流量（运输层控制的是端到端的流量）

  - 差错控制

  	- 循环冗余校验（CRC），处理**位错**。
  	- 自动重传请求（ARQ），处理**帧错**（帧的丢失，重复或失序等）。

  - 检错编码 王道P69

    - 奇偶校验码
    	- 对于**奇**校验，只能检测**偶**数个错误。
    	- 对于**偶**校验，只能检测**奇**数个错误。
    - 循环冗余码（CRC）（可以纠错，但数据链路层不使用它的纠错功能，帧出错直接丢弃）
      - 帧检验序列（FCS）
      - 在数据的低位端加上 $r$ 个 $0$ 后再进行模二除法，取余数放于新添加 $0$ 的位置。
      - $r$ 为生成多项式的最高次数。

  - 纠错编码 王道P70

  	- 海明码
  		- $n$ 为有效信息位数，$k$ 为校验码位数，则其应满足 $n + k \le 2^k - 1$，即总位宽小于等于校验码能表示的状态数减一。（减一是因为最后状态位全为 $0$ 表示无差错）
  		- 检错结果为 $000$（全零） 则说明无错。
  		- 非全零则说明出错，将该结果数值代表的位取反即可纠错。
  		- 码矩
  			- 检错 $d$ 位，需要码距 $d+1$ 。
  			- 纠错 $d$ 位，需要码距 $2d+1$ 。

### 流量控制与可靠传输

- 注意，**实际的数据链路层很少采用可靠传输**，但按 408 考纲，OSI 模型有这个内容。

- 以下以“帧”为单位讨论，实际要在运输层，以“分组”为单位讨论，原理是类似的。
- 如果链路层采用可靠传输，那么是对**帧**编号，而运输层是对**字节**编号。

- 流量控制方式和可靠传输机制交织在一起。

#### 流量控制方式

- 停止等待控制
	- 发送一帧，确认一帧。
	- 简单的停止等待如果发送一帧后没有收到确认，则会一直等待下去。
- 滑动窗口控制
	- 窗口是连续的。
	- 在接收方，帧的序号落在接收窗口内才接收，否则丢弃。
	- 接收窗口为 $1$ 时，可保证有序接收（因为未按序到达的都被丢弃了）。
	- 数据链路层的滑动窗口大小是固定的，在运输层是不固定的。

#### 可靠传输机制

- 自动重传请求（ARQ）
	- （SW）停止-等待 ARQ
	
	- 连续 ARQ 协议
	
		因为可以连续地发送比特，所以叫连续 ARQ 。
	
		- （GBN）后退 N 帧 ARQ
		- （SR）选择性重传 ARQ
	
- 做题要看清协议，若没有指明协议，可能要各个协议都考虑。

- 注意帧编号从 $0$ 开始。

#### 单帧滑动窗口与停止等待协议（SW）

- 交替地用 $0,1$ 来表示帧。
- 发送方接收方都有帧缓冲区，收到确认后即可清空缓冲区。
- 发送帧后设置超时计时器。
- 当确认帧丢失时，接收方收到重传的数据帧后，会重传一个该数据帧对应的确认帧，确认帧发生了重传。

#### 多帧滑动窗口与后退 N 帧协议（GBN）

- 可以连续发送帧。
- 重复发送最后一个正确帧后的所有帧。
- 接收方只允许按顺序接收帧。
- 发送帧后设置超时计时器。
- 窗口大小
	- 接收窗口一直等于 $1$ 。
	- 若用 $n$ 比特编号，则发送窗口尺寸 $W_T$ 满足 $1 \le W_T \le 2^n - 1$（窗口尺寸小于等于帧编号的状态数减一）。

#### 多帧滑动窗口与选择重传协议（SR）

- 发送帧后设置超时计时器。
- 一但接收方怀疑帧出错，发送否定帧（NAK）给发送方，要求对 NAK 指定的帧进行重传。
- 窗口大小
	- 若用 $n$ 比特编号，则接收窗口尺寸 $W_R$ 和发送窗口尺寸 $W_T$ 满足 $W_R + W_T \le 2^n$ 。（窗口尺寸和小于等于帧编号的状态数）
	- 实际上，GBN 的窗口大小也满足该不等式，只是 GBN 的 $W_R$ 一直等于 $1$ 。
	- SR 的接收窗口和发送窗口的**最大值**为 $W_R = W_T = 2^{n-1}$，即总状态数的一半。
	- 对比
		- 接收窗口尺寸超过发送窗口是没有意义的。
		- 但发送窗口尺寸是可以超过接收窗口的。
	- 一般情况下，SR 协议中接收窗口和发送窗口的大小总是相同的。
- 接收端所需缓冲区的数目等于窗口的大小。
- 控制窗口的大小的意义是，当**所有确认帧都丢失而导致超时重发时**，接收端仍能依据序号区分新旧帧。

#### 性能指标

- 信道利用率

  有多种计算方法

  - 这是针对发送方的指标。

  - 时间角度的定义

  	发送方在一个发送周期内，有效发送数据的时间所占的比例。

  - 发送周期

  	发送方开始发送数据到收到第一个确认帧为止的时间。
  	
  	- 发送周期要考虑发送**一个**帧的时间，RTT，以及发送**一个**确认帧的时间。
  	
  	- 在这段时间内可以发送多帧，而不增加周期时间长度。 王道P79.15
  	- 常要考虑一个发送周期内能发送多少帧。
  	
  - 发送时间

    帧长除以发送速率。

- 信道吞吐率

	$信道吞吐率 = 信道利用率 \times 发送方的发送速率$ 。（即是**有效利用的发送速率**）
	
- 计算利用率时注意发送的帧数和帧长的关系，当发送速率一定时，发送的数据总量与帧长无关，但发送的帧数与帧长有关，且帧数可以反映帧序号的范围，而帧序号的范围是有限的，反过来可以影响能够发送的帧数。

- 当确认是捎带时，计算发送周期时相同于确认帧的帧长与数据帧相等。

- 注意，**有效数据率**考虑的是有效数据，不是整个帧长，发送时延要考虑整个帧长。

- 线路效率 = 信道吞吐率 / 信道带宽 王道P236.7

### 介质访问控制

- 介质访问控制指对多个结点对信道的访问进行控制，以使其能够正确通信。
- 属于数据链路层的一个子层，**介质访问控制（MAC）子层**。
- 分类
	- 信道划分介质访问控制（静态）
	- 随机访问介质访问控制（动态）
	- 轮询访问介质访问控制（动态）

#### 信道划分介质访问控制

使用多路复用技术，将广播信道转化为点对点信道。

- 频分多路复用（FDM）
	- 把基带信号调制到不同频率载波上。
	- 分配各子信道的带宽可不相同。
	- 相邻信道加入保护频带。
- 时分多路复用（TDM）
	- 将一条物理信道划分为若干时间片。
	- 统计时分多路复用（STDM，又称异步时分多路复用）
		- 动态地分配时间片。
- 波分多路复用（WDM）
	- 即是光的频分多路复用。
	- 一根光线中传输不同频率的光信号。
	- 各路光信号互不干扰，最后用波长分解器分解各路波长。
- 码分多路复用（CDM）也叫**码分多址（CDMA）**（与 CSMA 区分） 王道P87
	- 用不同的编码区分子信道。
	- 既共享信道的频率，又共享时间。
	- 每个站点分配码片（$m$ 位）
	- 码片序列，码片序列反码
	- 不同站点的码片相互正交

#### 随机访问介质控制

王道P88

- 随机访问控制协议又称争用型协议。
- 各用户随意地发送信息。
- 碰撞冲突
- 冲突处理

##### ALOHA 协议

- 纯 ALOHA 协议
	- 不进行检测，直接发送数据。
	- 若未收到确认，则认为发生了碰撞。
	- 重传策略
		- 碰撞后随机等待一段时间重传。
		- 再次碰撞，则再随机等待一段时间重传，直至重传成功。
	- 最大网络吞吐量（$T_0$ 时间内成功发送的平均帧数）：$0.184$ 。
- 时隙 ALOHA 协议
	- 各站在时间上同步起来，将时间划分为时隙（Slot）。
	- 规定只能在每个时隙开始时发送数据。
	- 时隙的长度使得每个帧正好在一个时隙内发送完毕。
	- 重传策略
		- 与纯 ALOHA 协议类似。
	- 最大网络吞吐量：$0.368$ 。

##### CSMA 协议

载波侦听多路访问（CSMA）

- 分类

	- 根据侦听方式和侦听到信道忙的处理方式，CSMA 分为以下三种
		- 1 - 坚持 CSMA
		- 非坚持 CSMA
		- p - 坚持 CSMA

	- 注意 CSMA/CD 和 CSMA/CA 是 CSMA 的改进方案，有不同的使用场景。

- 1 - 坚持 CSMA
	- 首先侦听信道
		- 空闲直接发送数据（发送概率为 $1$）
		- 忙则坚持侦听，直到信道空闲则发送数据。
- 非坚持 CSMA
	- 首先侦听信道
		- 空闲就发送数据，
		- 忙则放弃侦听，等待一个随机的时间后再侦听。
- p - 坚持 CSMA
	- 用于时分信道，具有时隙。
	- 首先侦听信道
		- **空闲**则以概率 $p$ 发送数据，概率 $1-p$ 推迟到下一个时隙侦听，反复，直到发送成功或检测到忙。
		- **忙**则持续侦听（从下一个时隙开始），直到空闲，按空闲状态处理。

##### CSMA/CD 协议

载波侦听多路访问/碰撞检测（CSMA/CD）

- 适用于总线型网络或半双工网络。

- 碰撞检测就是边发送边侦听。

- 先听后发，边发边听，冲突停发，随机重发。

- 在发送过程中，如果检测到碰撞，则发送一个拥塞信号，然后执行指数退避算法。

- 争用期（冲突窗口，碰撞窗口）

	以太网端到端的往返时间，传播时延的两倍（$2\tau$）。

	- 经过争用期还未检测到碰撞，才能确定本次发送不会产生碰撞。

- 最小帧长

  - $最小帧长 = 争用期 \times 数据传输速率 = 总线传播时延 \times2\times 数据传输速率$ 。
  - **使一个帧至少在一个争用期内才能发送完（即最短帧长等于争用期内能发送的比特数）。**
  - **以太网最小帧长为 $64B$**，之下长度的帧都会被丢弃，若要发送之下长度的数据，需要加入**填充**字段。
  - MAC 帧**首部和尾部共** $18B$，得以太网**最小数据载荷**为 $46B$，少于这么多数据则要填充。 

- 二进制指数退避算法（动态退避）

	- 基本退避时间 $2\tau$ 。
	- 重传次数 $k$，$k$ 从 $1$ 开始，$k$ 不能超过 $10$ 。
	- $0,1, ...,2^k-1$中随即取出一个数 $r$，退避时间就是 $r$ 倍基本退避时间，即 $2\tau r$ 。
	- 当重传到 $16$ 次仍不成功，认为此帧永远无法正确发出，抛弃此帧，向高层报告错误。

##### CSMA/CA 协议

载波侦听多路访问/碰撞避免（CSMA/CA）

- 适用于无线局域网（802.11）。

- 碰撞避免指尽量降低碰撞概率。

- 802.11 使用确认 / 重传（ARQ）方案（即 ARQ-SW，停止等待 ARQ），发送一帧，确认一帧。

- 帧间间隔（IFS）

	发送完一帧后，还要等待一个 IFS 后才能发送下一帧。依据所要发送帧的类型，分为三种：

	- SIFS（短 IFS）（最短）

		用于控制帧和确认帧。

	- PIFS（点协调 IFS）（中等）

	- DIFS（分布式协调 IFS）（最长）

		用于侦听到空闲后预约信道。

- 算法流程 王道P93

- 隐蔽站问题

	- A，B 相隔较远，检测不到对方，但都在 AP 范围内，当 A，B 同时向 AP 发送数据，就发生碰撞。

	- 对信道进行预约，源站先**广播**一个**短请求发送 RTS 控制帧**，若信道空闲，则 AP **广播**一个**允许发送 CTS 控制帧**。

	- RTS

		包含源地址，目的地址，通信（含确认）所需时间。

	- CTS

		给源站传达许可，同时指示其它站点在预约期不要发送。

- CSMA/CD 和 CSMA/CA 的区别 王道P94

#### 轮询访问介质访问控制

- 令牌传递协议
	- 令牌在各个结点中以**固定次序**传递。
	- 令牌是由特殊的比特组合构成的帧。
	- 只有持有令牌的站点才能发送，不会发生冲突（只有一个令牌）。
	- 令牌的**传递路线**在**逻辑上**是一个环。
	- 实际的线路可以是环形，也可以不是环形。
	- **适合高负载广播信道。**

### 局域网

局域网（LAN）

#### 基本概念

- 拓扑结构
	- 星形
	- 环形
	- 总线形
	- 复合型结构（星形和总线形结合）
- 传输介质
	- 双绞线（主流）
	- 无屏蔽双绞线（UTP）
	- 铜缆
	- 光纤
- 介质访问控制方式
	- 用于总线形局域网
		- CSMA/CD
		- 令牌总线
	- 用于环形局域网
		- 令牌环
- 三种特殊局域网拓扑实现
	- **以太网**
		- 逻辑拓扑 总线形
		- 物理拓扑 星形或拓展星形结构
	- 令牌环（IEEE 802.5）
		- 逻辑拓扑 环形
		- 物理拓扑 星形
	- FDDI（光纤分布数字接口，IEEE 802.8）
		- 逻辑拓扑 环形
		- 物理拓扑 双环结构
- IEEE 802 标准对应于 OSI 参考模型数据链路层和物理层。
	- 其中，数据链路层分为：
		- 逻辑链路控制（LLC）子层
		- 媒体接入控制（MAC）子层（又称 介质访问控制子层（MAC））

#### 以太网与 IEEE 802.3

- IEEE 802.3 标准

	- 描述物理层和数据链路层的 MAC 子层的实现方法。

	- 逻辑上为总线形
	- 采用 CSMA/CD
	- 通常将使用 IEEE 802.3 标准的局域网称为以太网。

- 以太网简化通信的措施

	- 采用无连接方式，不对数据帧编号。
	- 使用曼彻斯特编码，便于同步。

- 以太网的传输介质 王道P105

	- 粗缆 10BASE5 总线形
	- 细缆 10BASE2 总线形
	- 双绞线 10BASE-T（T 表示双绞线）  星形
	- 光纤 10BASE-FL（F 表示光纤）  点对点
	- 都是曼彻斯特编码
	
- 网卡（网络适配器，网络接口卡 NIC）

  - 网卡装有处理器和存储器，工作在**数据链路层和物理层**。
  - 网卡和局域网的通信通过电缆或双绞线以**串行**方式进行。
  - 网卡和计算机通信通过计算机主板上的 I/O 总线以**并行**方式进行。
  - 介质访问控制（MAC）地址

- 以太网的 MAC 帧

  - MAC 地址又称物理地址，长 $6$ 字节。
  - MAC 帧格式有两种标准（大体相似）
    - DIX Ethernet V2 标准
    - IEEE 802.3 标准
  - 前导码
    - 前同步码
    - 帧开始定界符
    - MAC 帧不需要帧结束符，但是有首部和尾部。
    - **数据**的长度范围：46 ~ 1500 字节（注意，最小帧长为 64 B）
    - 校验码（FCS）
      - 采用 32 位 CRC
      - 检验范围：目的地址到**数据段末尾**。（不校验前导码）（校验不包括 FCS 的位置）

- 高速以太网

  速率达到或超过 100Mb/s 的以太网为高速以太网。

  - 100BASE-T 以太网

  	100 Mb/s

  	- 支持全双工和半双工。
  	- 半双工使用 CSMA/CD 协议
  	- 全双工时不使用 CSMA/CD 协议（不需要使用）。

  - 吉比特以太网（千兆以太网）

  	1 Gb/s

  	- 支持全双工和半双工
  	- 半双工使用 CSMA/CD 协议
  	- 全双工时不使用 CSMA/CD 协议。

  - 10 吉比特以太网

  	10 Gb/s

  	- 只支持全双工，不使用 CSMA/CD 协议。

#### TEEE 802.11

王道 P107

用于两类无线局域网

- 有固定基础设施（即固定基站）无线局域网

	- 接入点 AP（基站）

	- 基本服务集 BSS

		本 BBS 内可以直接通信，以外要通过基站（AP）。
  	
	- 服务及标识符 SSID
  	
	- 基本服务区 BSA
  	
	- 分配系统 DS
  	
	- 扩展服务集 ESS

- 无固定基础设施移动自组织网络（自组网络）

	- 中间结点都为转发结点，都具有路由器的功能。

	- 自组网络和移动 IP 的区别

		- 移动 IP 用多种方法连接到因特网，基于固定网络中的各种路由协议。

		- 自组网络具有自己特定的路由协议，且不和因特网相连。

#### 令牌环网

  王道 P108

### 广域网

#### 基本概念

- 局域网可以通过广域网和另一个局域网通信。
- 在广域网和局域网中，主机在**网内通信**都只需要使用**物理地址**。
- 广域网由**结点交换机**及连接这些结点交换机的链路（专门的链路）组成。
- 区分
	- 结点交换机在单个网络中**转发分组**。
	- 路由器在多个网络构成的互联网中转发分组。
- 广域网使用分组交换技术。
- 广域网和局域网的区别与联系 王道P115
- PPP 协议和 HDLC 协议是目前最常用的两种广域网数据链路层控制协议。

#### PPP 协议

- 面向字节。（PPP 帧长度都是整数个字节）

- 包含

	- 链路控制协议（LCP）

		控制和管理**数据链路**。

	- 网络控制协议（NCP）

		控制和管理与使用的各种**网络层协议**的联系。

	- 一个封装 IP 数据报的方法（IP 数据报作为 PPP 帧的数据部分）

- PPP 是点对点的，不是总线形，无需采用 CSMA/CD，所以没有最短帧长，数据部分占 0 ~ 1500 字节。

- 帧检验序列（FCS）采用 CRC

- 提供差错检测但不提供纠错，只保证无差错接收（使用硬件进行 CRC 校验）

- 是**不可靠传输**协议，因此也不使用序号和确认机制。

- 只支持点对点链路。

- 只支持全双工链路。

- 两端可以运行不同的网络层协议。

- 实现透明传输的方式

	- 在异步线路中，采用字节填充法。（默认异步线路）
	- 在同步线路中，采用硬件完成比特填充。（HDLC 也这样）

#### HDLC 协议

高级数据链路控制协议（HDLC）

王道 P117

- 面向比特。

- 透明传输使用比特填充。

- 全双工通信。

- CRC 检验

- 对信息帧按顺序编号，提供**可靠传输**。

- HDLC 是 ISO 提出的面向比特型的数据链路层协议，不属于 TCP/IP 协议簇。

- 站分为三类

	- 主站

		发出命令帧

	- 从站

		发出响应帧

	- 复合站

		既有主站功能，又有从站功能。

		可以发出命令帧和响应帧。

- HDLC 适用于两种基本链路配置方式

	- 非平衡配置

		一个主站控制整个链路。

	- 平衡配置

		链路两段都是复合站。

- 数据操作方式

  - 正常响应方式（属于非平衡结构）

  	主站可向从站发送数据，但从站经过主站允许后才能发送数据。

  - 异步平衡方式（属于平衡结构）

  	每个复合站都可以互相传输。

  - 异步响应方式（属于非平衡结构）

  	从站可以自行传输数据，无需主站允许。
  	
  - （响应就是非平衡，就是区分主站和从站）

- HDLC 帧分为三类

	- 信息帧（I 帧）

		用来传输数据。

	- 监督帧（S 帧）

		用于流量控制和差错控制，执行对信息帧的确认，请求重复和请求暂停等功能。

	- 无编号帧（U 帧）

		用于链路的建立、拆除等功能。

### 数据链路层设备

王道 P121

#### 网桥

- 工作在链路层的 MAC 子层。
- 可以隔离冲突域。
- 存储转发帧，可以转换协议。
- 透明网桥（选择的不是最佳路由）
	- 自学习算法处理收到的帧
		- 每收到一个帧就记录下源地址和进入网桥的端口。
	- 使用生成树算法避免帧兜圈子。（生成树一般不是最佳路由）
- 源路由网桥（选择最佳路由）
	- 这里的最佳路由指发送帧的往返时间最短的路由。
	- 路由选择由源站负责，网桥只根据信息按路径发送。
	- 源站广播一个**发现帧**。王道P121
	- 发现帧的数量指数增加，可能会使网络严重拥塞。

#### 局域网交换机（以太网交换机）

- 相当于多端口网桥，工作在数据链路层。

- 可隔离冲突域。

- 具有虚拟局域网（VLAN）功能。

- **使用 VLAN 后**，既可隔离冲突域，也可隔离广播域。

- 自学习算法建立转发表。

- 采用两种交换模式

	- 直通式

		只检查 $6B$ 的目的地址，直接转发，速度快，但缺乏智能性。王道P128.15

	- 存储转发式

		存储到缓存中，检查数据是否正确，可靠性高，但延迟较大。

- 局域网交换机的端口可以支持两种工作模式，半双工模式和全双工模式。

- 对于 $m$ Mb/s 的交换机端口，其半双工端口带宽为 $m$ Mb/s，全双工端口带宽为 $2m$ Mb/s 。 王道P128.14

- 注意

  - 网桥的端口一般连接网段（线路），交换机的端口一般直接连接主机。
  - 设备隔离冲突域和广播域的总结 王道P133

## 网络层

### 基本概念

- 路由器的功能

	- 路由选择

		- 确定路径。

		- 根据路由选择算法得出**路由表**。
		- 路由表应对网络拓扑变化的计算最优化。

	- 分组转发

		- 转发分组。

		- 根据路由表得出**转发表**。
		- 转发表应使查找过程最优化。

	- 一般可统称为路由表。

	- 路由器互联的局域网

		- 物理层，数据链路层，网络层协议可以不同。
		- 其以上的高层协议必须相同。
		- 网络层有不同，例如 IPv4 和 IPv6

- 拥塞控制

	- 过量分组引起的网络性能下降称为拥塞。
	- 判断是否拥塞的方法：观察网络的**吞吐量**和**网络负载**的关系。
	- 拥塞控制是全局性过程，单一地增加资源并不能解决拥塞。
	- 区分
		- 流量控制是发送端的点对点通信量的控制。
		- 拥塞控制是整个网络全局性的控制。
	- 拥塞控制方法类型
		- 开环控制
			- 一种静态的预防方法
			- 设置好应对规则，系统一但运行就不再修改。
		- 闭环控制
			- 采用检测系统检测网络状况。

### 路由算法

- 静态路由算法（非自适应路由算法）

	人工配置，可以随时人工改变。

- 动态路由算法（自适应路由算法）

	自动配置。

	- 距离向量路由算法
	- 链路状态路由算法

#### 距离向量路由算法

- 每个结点定期或在更新时将整个**路由选择表**传送给**相邻**结点。（该路由器**全部信息**）
- 路由选择表
	- 目的地（另一结点）
	- 路径代价（距离，跳数）
- 跳数定义
	- 到直接相连的网络为 $1$（当前路由器）
	- 到非直接相连的网络为经过的路由器数 $+1$ 。（或路径上包括起点路由器的路由器个数）
	- 注意，跳数从路由器发出算跳数，若是从一个网络中的主机发入本网络的一个路由器，则不算一跳。

#### 链路状态路由算法

- 定期将链路状态传播给**所有**结点。
	- 传播的链路状态是相邻路由器的链路状态。
	- 传播的链路状态信息是该路由器的**部分信息**。
- 每个结点都具有完全的网络拓扑信息。
- 主动测试相邻结点状态。

#### 层次路由

- 自治系统

- 内部网关协议（IGP）

	RIP，OSPF

- 外部网关协议（EGP）

	BGP

- OSPF 可再将自治系统划分为若干区域。

### IPv4

王道P144

#### 分组格式

- 首部固定部分长度：$20B$ 
- 首部长度字段，单位为 $4B$ 
- 总长度字段，单位为 $1B$ 
- 片偏移字段，单位为 $8B$ 
- 标识
	- 分组是否属于同一个数据报。

- 标志
  - MF（More Fragment）
  	- $MF =1$ 表示后面还有分片。
  - DF（Don't Fragment）
  	- $DF = 1$ 表示不允许分片。
- 检验字段
  - 仅检查分组首部。


#### IP 数据报分片

- MTU

  **数据链路层**能承载的最大数据长度，最大传送单元（MTU）。

  - MTU 特指数据链路层的最大数据长度，默认为 $1500B$，注意，其中包括必需的 IP 头部 $20B$，只剩下 $1480B$ 可用来装数据。
  - 若不是默认值，也要注意考虑 IP 的头部长度。
  - 说某一网络的 MTU 是多少，是指的其数据链路层。
  - 一个数据报包含 $20B$ 的头部，对其分片时其**有效数据长度**是总长度减 $20B$ 。王道P159.2
  - 有效数据长度若不能被 $8$ 整除，则只能选小一点的数。 王道P159.3

- 片在目的站的网络层被重新组装。

- 标志字段

	- MF
	- DF

- 片偏移字段（单位 $8B$）

	- 片偏移字段的值表示**当前分片的有效数据的第一个字节**是原数据报的第几个 $8$ 字节。
	- **除了最后一个片外**，所有片的有效数据载荷都是 $8$ 的倍数（有效数据不包括填充的数据）。
	- 数据的字节编号从 $0$ 开始。

#### 网络层转发分组的流程

- 提取目的 IP 地址，得到目的网络地址。
- **判断网络地址**，直接交付或间接交付。（直接交付的网络可能有多个）
- 间接交付则查看路由表
	- 是否有**特定主机路由**
		- 特定路由格式：$某个地址/32$
		- 特定路由的子网掩码：$255.255.255.255$ （网络最具体）
	- 一般路由项
	- 默认路由
		- 默认路由格式：$0.0.0.0/0$ 
		- 默认路由的子网掩码：$0.0.0.0$ （网络最不具体）（注意与特定路由的子网掩码区分）
			- 有时可以表示"其它网络"，若题目没有给出新增网络的地址，则可用默认路由代表那个新增网络。 王道P185.5
	- 报告转发分组出错

#### IPv4 地址

计网P119P120P121

- 路由器仅根据网络号转发分组。
- 路由器每个端口都要分配一个 IP 地址。
- $\begin{cases} 1 \le A \le 126 \\\\ 128\le B \le 191 \\\\ 192 \le C \le 223 \end{cases}$ 。
- $127 \to loopback$ （环回地址）
- 注意
	- IPv4 的地址是点分十进制，共$32$ 位（不要忘了打点）
	- IPv6 的地址是冒号十六进制，共 $128$ 位（不要忘了冒号）
	- MAC 地址是横杠十六进制，共 $48$ 位。（不要忘了横杠）


#### NAT

网络地址转换（NAT）

- 私有 IP 地址（可重用地址）
- 路由器对目的地为私有 IP 地址的数据报一律不进行转发。
- 使用私有 IP 地址的网络称为专用互联网或本地互联网。
- NAT 路由器至少有一个有效的外部全球地址。
- NAT 路由器有 NAT 转发表
	- 本地地址，端口
	- 外部地址，端口
- NAT 路由器会更换数据报的 IP 地址。
- 普通路由器只工作在网络层，而 NAT 路由还要查看和转换运输层的端口号。
- NAT 占用的网段 王道P147
	- A 类：$10.0.0.0$ ~ $10.255.255.255$ 
	- B 类：$172.16.0.0$ ~ $172.31.255.255$ 
	- C 类：$192.168.0.0$ ~ $192.168.255.255$ （主要，见到一定要注意它是 NAT 的私有 IP 地址，在经过 NAT 路由器时，目的 IP 地址或源 IP 地址会改变。）
- NAT 的转发表不会自动变换，必须要管理员手动添加。
- NAT 的转发表中，源 IP 地址和源端口或转换端口（注意发送的方向）要结合起来看。 王道P157.40


#### 子网

- 划分子网
	- 将 IPv 4 的网络号再划分出子网号字段。
	- **子网号字段不能为全 $0$ 或全 $1$（CIDR 可以）**（千万注意考虑）
	- 子网掩码
	- 默认子网掩码（A 类，B 类，C 类）
	
- 无分类域间路由选择（CIDR）（构造超网）
	- 路由聚合（构造超网）
		- 路由聚合是在最具体的情况下聚合，即在前缀匹配尽量长的情况下聚合。 王道P159.6
	- 最长前缀匹配（最佳匹配）
	
- 划分子网只增加了子网的数量，并没有增加网络的数量。

- 划分子网减少了广播域的大小。

- 当子网段长度为 $0$ 时，即全部是主机位，不是没有子网，而是子网数为 $1$ 。

- 子网号是在原主机位进行划分，子网掩码指示网络号和子网号共同的宽度。

- 处于不同网段的主机只能通过路由器进行 **IP 通信**，即使它们处在同一个局域网中。 王道P156.35

- 变长子网划分 王道159.54

	- 情况

		- 各个子网的大小不相等。
		- 划分位数总容量与子网个数不匹配。
		- 一定的可用划分位数下，最大子网和最小子网。

	- 以 $4$ 位用于划分子网为例

		可划分为 $5$ 个变长子网。

		- $0$（注意第一个和最后一个子网）
		- $10$
		- $110$
		- $1110$
		- $1111$（注意第一个和最后一个子网）
	
- 杂项分配问题

  - 子网号字段和 CIDR 方式的主机号都不能被指派为全 $0$ （子网的网络号）或全 $1$ （广播地址）。
  - 考虑给主机分配多少位时，一定注意主机号全 $0$ 和全 $1$ 不能分配给主机，要留出富余。
  - 考虑局域网主机数需要的地址数时，路由器的每个端口也需要一个 IP 地址。
  - DNS 服务器一般是一个特定路由，互联网一般是一个默认路由。 王道 P160.12
  - 有子网存在，一定要先分清是类别子网划分还是无分类编址 CIDR。
    - 类别子网划分子网号不能为全 $0$ 和全 $1$。
    - 若网络内存在子网号为全 $0$ 和全 $1$ 的主机，则使用的是 CIDR。
    - 若使用划线掩码记法，则是 CIDR；若使用一般 255 掩码记法，则不一定
  - 网络地址可以根据主机的地址得到。
  - 没有 CIDR 时，不能路由聚合。

#### 几个协议

王道P151

##### 地址解析协议（ARP）

- ARP 表
	- 存放 IP 地址到 MAC 地址的映射。
- 工作在网络层
- 若要找的主机不在当前网络，则路由器转发该 ARP 请求分组，这时，路由器向请求的主机回答**自己的 MAC 地址**。 王道P203

##### 动态主机配置协议（DHCP）

- 应用层协议，基于 UDP（其客户和服务端之间通过**广播 UDP** 来交互） 王道P152

##### 网际控制报文协议（ICMP）

- 属于网络层协议（IP 层）
- ICMP 报文作为 IP 数据报的数据部分发送出去。
- 分类
	- ICMP 差错报告报文
		- 终点不可达
		- 源点抑制
		- 时间超过
		- 参数问题
		- 改变路由（重定向）
	- ICMP 询问报文
		- 回送请求和回答报文
		- 时间戳请求和回答报文
		- 掩码地址请求和回答报文
		- 路由器询问和通告报文
- 不发送 ICMP 差错报告报文的情况
	- 对差错报文不再发送差错报文
	- 对第一个分片外的所有后续分片不发送差错报文。
	- 对具有组播地址的数据报不发送差错报文。
	- 对具有特殊地址（比如 $127.0.0.0$ 或 $0.0.0.0$）的数据报不发送差错报文。
- ICMP 应用
  - Ping
  	- 使用 ICMP 回送请求和回答报文。
  	- 工作在应用层，直接使用网络层的 ICMP，而未使用运输层的 TCP 或 UDP 。
  - Traceroute / Tracert
  	- 使用 ICMP 时间超过报文
  	- 工作在网络层

### IPv6

- IPv6 只有在源结点才能分片，是端到端的，传输路径中的路由器不能分片，所以一般意义上，IPv6 不允许分片。
- IPv6 的首部长度必须是 $8B$ 的整数倍，IPv4 首部是 $4B$ 的整数倍。
- IPv6 没有校验和字段。
- IPv6 的首部长度是固定的。
- IPv6 地址分类
	- 单播
	- 多播
	- 任播
- 冒号十六进制，缩写时双冒号只允许出现一次。
- IPv4 向 IPv6 的过渡策略
	- 双协议栈
	- 隧道技术

### 路由协议

- 自治系统（AS）
	- 一个自治系统内的所有路由器在本系统内必须是连通的。
	- 自治系统内的路由器既要运行内部协议，也要运行外部协议。

#### 域内路由选择

##### 内部网关协议（IGP）

- 路由信息协议（RIP）
	- **距离向量**（跳数）
	- 跳数定义
		- 到直接相连的网络为 $1$
		- 到非直接相连的网络为经过的路由器数 $+1$ 。（或路径上包括起点路由器的路由器个数）
	- 跳数最大为 $15$，为 $16$ 时表示网络不可达。
	- 特点
		- 只和相邻路由器交换信息。
		- 交换的信息是当前路由器所知道的全部信息，即自己的路由表。
		- 按固定时间间隔交换信息。
	- 距离向量算法 计算机网络P155
	- RIP 路由表项
		- 目的网络
		- 跳数
		- 下一跳路由器

##### 开放最短路优先（OSPF）

- **链路状态**
- 特点
	- 向本自治系统内所有路由器发送信息。（泛洪法）
	- 发送的信息是与本路由器相邻的路由器之间的链路状态，是本路由器的部分信息。
	- 只有链路变化时才用泛洪法发送信息。
- 每条链路可设置代价。
- 每个链路状态都一个序号，序号越大，状态就越新。
- 可将一个自治系统划分为更小的**区域**。
- Dijkstra 最短路算法找最短路，但是路由表中只有下一条路由器和总代价。
- OSPF 路由表项
	- 目的网络
	- 总代价（到达目的网络的最短路径的代价）
	- 下一条路由器

#### 域间路由选择

##### 外部网关协议（EGP）

- 边界网关协议（BGP-4）
	- **路径向量**（交换到达某个网络所要经过的路径）
	- 每个自治系统至少一个 BGP 发言人（边界路由器）。
	- 在 BGP 刚运行时，交换整个路由表，但以后只有在发生变化时才更新有变化的部分。
	- 选择较好而不是最好的路径（局部最优解）
	- BGP 可以沟通不同的（包括协议不同的）自治系统。

#### 总结

王道P182

- RIP 是应用层协议，在运输层使用 UDP
- OSPF 是网络层协议，直接使用 IP 数据报传送数据。
- BGP 是应用层协议，基于 TCP

### IP 组播

- 概念
  - 组播一定只用于 UDP
  - 主机使用 IGMP（因特网组管理协议） 加入组播组。
  - 源主机只发送一份数据，数据在传送路径出现分叉时将分组复制为多份后再转发。
  - 组播需要路由器支持才能实现，运行组播协议的路由器叫**组播路由器**。
- 组播方式
  - 在本局域网上进行硬件组播。
  - 在因特网上进行组播。
  	- 在因特网组播的最后阶段，还是用硬件组播交付给组播组的所有成员。
- 组播地址
  - 组播地址原理
    - 组播是发送给若干个计算机，因此要使用特殊的目的地址，即组播地址。
    - 一个组播地址代表一个组播组。
    - 主播地址分为 IP 组播地址和 MAC 组播地址。
    - 组播地址只用于目的地址，IP 组播地址和 MAC 组播地址都是如此。
    - 使用情况
      - 组播信息在因特网，即路由器之间传播时，IP 地址使用 IP 组播地址，MAC 地址使用路由器的一般 MAC 地址。
      - 组播信息在局域网，即路由器到主机之间传播时，IP 地址使用 IP 组播地址，MAC 地址使用 MAC 组播地址。（硬件组播）
  - IP 组播地址（$32$ 位）
  	- IP 组播使用 D 类地址。
  	- 每个 D 类地址标志一个组播组。
  	- 并非所有 D 类地址都可以作为组播地址。
  	- IP 组播地址范围：$224.0.0.0$ ~ $239.255.255.255$ 即（$224,239$）
  	- 构成方式
  		- 前四位固定为 $1110$（D 类地址的前四位）
  		- 可供分配的 $28$ 位中，只有后 $23$ 位能用作组播，前 $5$ 位不做映射（这五位当成空就好）。
  	- 注意
  		- 组播数据报只提供“尽最大努力交付”，不提供可靠交付。
  		- 对组播数据报不产生 ICMP 差错报文。
  - 硬件（MAC）组播地址 （$48$ 位）
  	- 构成方式
  		- 前 $25$ 位固定
  		- 后 $23$ 用作组播
  		- MAC 组播地址的后 $23$ 位就是 IP 组播地址的后 $23$ 位。

#### IGMP

因特网组管理协议（IGMP）

- IGMP 不是对因特网范围内所有组播组成员进行管理的协议，而是对某个**本地局域网**进行管理的协议。
- IGMP 让本地局域网上的**组播路由器**知道本局域网上是否有**主机**加入或退出了某个组播组。
- IGMP 是 TCP/IP 的一部分。
- 加入组时，主机向组播组的组播地址发送一个 IGMP 报文，声明加入。
- 组播路由器周期性地探询本地局域网的主机是否还是某个组的成员。

#### 组播路由选择协议

- 找出以源结点为根结点的**组播转发树**。
- 不同多播组对应不同的转发树，同一组播组，对不同的源点有不同的转发树。
- 主要三种组播路由选择协议
	- 基于链路状态的协议。
	- 基于距离-向量的协议。
	- 建立在任何路由器协议之上，称为**协议无关的组播（PIM）**。

### 移动 IP

具体原理一定看书

计算机网络 P414

王道 P192

#### 重要术语

- 移动结点

- 移动代理

	- 归属代理（本地代理）
	- 外埠代理（外部代理，外地代理）

- 归属网络

- 永久地址（归属地址，主地址）

- 转交地址（辅地址）

- 被访网络（外地网络）

- 移动绑定（绑定）


#### 注意点

- 在不使用移动 IP 的情况下，主机更换位置会使用 DHCP 协议自动获取新的 IP 地址（这个 IP 地址属于该地的网络）。
	- 因为主机离开原来 IP 地址的网段后，就无法正常发送和接收分组，因此要更换新的 IP 地址。
	- 但更换新的地址意味着原来保持的 TCP 等的连接会被中断，此时使用移动 IP 可以解决这个问题。
- 在使用移动 IP 的情况下，主机更换位置不改变 IP地址，一直使用**归属地址**。

### 网络层设备

#### 路由器

- 直接交付
- 间接交付
- 路由器隔离了广播域
- 路由器是网络层设备，实现了网络模型的下三层。
- 路由表（总是用软件实现）
- 转发表（既可用软件，也可用硬件实现）
- 转发只涉及一个路由器，而路由选择涉及很多路由器。
- 转发表由路由表计算得来。
- 分组的实际转发直接查看转发表。

## 运输层

也叫传输层。

### 基本概念

- 运输层是面向通信部分的最高层，也是用户功能的最低层。

- 提供应用进程间端到端的通信。

- 面向连接的服务可以保证**顺序交付**。

- 如果一个协议提供**确认机制**，则认为其是可靠的。

- 复用

	汇聚到主机外部（向低层流动）。

- 分用

	放射到主机内部（向高层流动）。

- 对收到的报文进行差错检测（首部和数据部分），网络层只检查首部，不检查数据部分。

- 端口

	- 端口是传输层服务访问点（TSAP）
	- 端口标识主机中的应用进程。
	- 数据链路层的 SAP 是 MAC 地址，网络层的 SAP 是 IP 地址，传输层的 SAP 是端口。
	- 软件端口，硬件端口，传输层使用的是软件端口。

- 端口号

	- 长度为 $16\ bit$ 。
	- 端口号只标识本计算机的应用进程。
	- 分类
		- 服务器端口号
			- 熟知端口号 $0$ ~ $1023$ 
				- 常见熟知端口号 王道P206
			- 等级端口号 $1024$ ~ $49151$
		- 客户端端口号
			- 短暂端口号（临时端口号） $49152$ ~ $65535$ 

- 套接字

	- IP 地址和端口号的聚合体。
	- 唯一的标识网络中的一台主机上的一个应用进程。

### UDP

- UDP 没有拥塞控制。
- 面向报文，一次发送或接收一整个报文，即不合并也不拆分，选择合适大小报文的任务由应用层负责。
- 首部格式
	- UDP 的首部为 $8B$，TCP 的首部为 $20B$ 
	- 源端口（需要对方回信时使用，不需要时可用全 $0$）
	- 目的端口
		- 数据报的长度，包括首部和数据，最小值为 $8$（仅有首部时）。
	- 长度
	- 校验和
		- 检验到有错则丢弃，不想使用校验时，直接置为全 $0$ 。
- 如果接收方发现目的端口号不正确，那么丢弃报文，并由 ICMP 发送“端口不可达”差错报文。
- UDP 校验 王道P210
	- 添加 $12B$ 的伪首部（其中包含了源 IP 地址和目的 IP 地址），
	- UDP 校验首部和数据两部分，而 IP 数据报只校验首部。
	- 二进制反码
	- 无差错时结果应全为 $1$ 。

### TCP

王道P216

计算机网络P217

- 提供可靠传输，提供可靠、有序、无丢失、不重复等。
- 面向连接，点对点连接（一对一）。
- 全双工通信。
- 面向字节流，但是一次交互一个大小不定的数据块。

#### 报文结构

- 序号

	- 占 $4B$
	- 每个字节都编号。
	- 序号字段指当前报文段所传送的数据块的第一个字节的序号。

- 数据偏移字段（即**首部长度**）

	- 单位 $4B$ 

- 校验和

	- 校验首部和数据两部分。
	- 加上伪首部。（只有协议字段做了更改，伪首部的其它字段完全和 UDP 伪首部一样）

- 选项字段

	- 长度可变。

	- 最大报文段长度（MSS）

		TCP 报文的**数据字段**的最大长度。

#### 连接管理

- 概念

	- 连接的端口称为套接字。
	- 采用客户/服务器方式。
	- 主动发起连接建立的应用进程称为**客户（Client）**，被动等待连接建立的应用进程叫**服务器（Server）**。

- 连接阶段 计算机网络P238

	- 连接建立（三次握手）

		- 服务器的资源是在完成第二次握手分配的，客户端资源是在完成第三次握手分配的。

	- 数据传送

	- 连接释放（四次挥手）

		- 最长报文段寿命（MSL）

- 注意各阶段的序号 王道P218

- 由客户机主动请求建立连接，但释放连接可以由服务器和客户任何一方主动进行。

	- 之所以服务器不主动建立连接，是服务器不知道当前客户的网络地址（客户的网络地址是经常变动的）。
	
- 注意，建立的第三次握手可以捎带，释放的第二第三次挥手可以合并在一起发送。（分析最少最多 RTT 时要注意）


**TCP 可靠传输**

王道P220

- 校验

	与 UDP 类似。

- 序号

	- 序号字段的值指本报文段的数据的第一个字节的序号。

- 确认

  - 累计确认
  - 只确认数据流中第一个丢失字节为止的字节。
  - TCP 面向字节，对每个字节编号，但是确认的单位是报文段。

- 重传

	- 超时重传
		- 每发送一个报文段设置一个计时器。
		- 加权平均往返时间（$RTT_s$）。 计算机网络P225
		- 超时重传时间（RTO）应略大于 $RTT_s$ 。
	- 冗余 ACK（冗余确认） 王道P220
		- 比期望序号大的失序报文段到达时，就发送冗余 ACK，指明下一个期待字节的序号。
			- 连续发送三个冗余 ACK 。（此时认为该报文段已经丢失，而不是滞留在网络中）
		- 与快重传联系。

#### TCP 流量控制

- 基于滑动窗口协议
	- 数据链路层的滑动窗口大小固定，不能动态变化。
	- 运输层的滑动窗口大小可以动态变化。
- 接收窗口（rwnd）
	- 在 TCP 拥塞控制中还有一个拥塞窗口（cwnd）。
	- **实际发送窗口大小取当前 rwnd 和 cwnd 的较小值。**

#### TCP 拥塞控制

- 慢开始
	- 慢开始门限（阈值）
	- 慢开始增长过程不能越过阈值。
- 拥塞避免
	- 加法增大
- 网络拥塞的处理
	- 发送方判断网络出现拥塞（未按时收到确认）
	- **阈值**减半（乘法减小）（**阈值变为**出现拥塞时，**拥塞窗口的一半**，但不能小于 $2$）
	- **拥塞窗口置 $1$ 个 MSS。**（拥塞窗口在传输**最开始**默认为 $1$）
		- 拥塞窗口的初值为 $1 MSS$ 。
	- 时刻都注意阈值和拥塞窗口。
- 快重传
	- 当发送方连续收到三个重复的 ACK 报文时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时。（此时认为该报文段已经丢失，而不是滞留在网络中）
- 快恢复
	- 对拥塞窗口重置值的改进，**默认不进行快恢复**。
	- 一但出现拥塞，阈值减半，拥塞窗口置为与阈值相等，然后直接拥塞避免（加法增大）。
- 杂项
  - **接收窗口**和**发送窗口**都是由**接收端**根据自己的接收能力进行调整。
  - **拥塞窗口**由**发送端**根据网络的拥塞情况进行调整。
  - 当前拥塞窗口的值，是上一个报文段的确认的作用。
  - 发送窗口的已发送数据，若未收到确认，则仍然缓存在发送窗口中。
  - TCP 连接已使用两个端口，若又有新的使用其中端口的 TCP 连接建立请求，则后续的请求失效，原来的连接正常运行。
  - TCP 每条连接不一定使用 GBN 或是 SR，如有相关计算，选更能满足题意的那个计算。
  - 发送一个**完全窗口**即是一次发送整个发送窗口所能容纳的数据量。 王道P236.9
  - TCP 开销 $20B$， IP 开销 $20B$，以太网开销 $26B$ 。王道P237.11
  - 如果一次最大发送量等于发送窗口值，则每发送一次都要等待确认，才能继续发送数据。 王道P237.12
  - TCP 的连接和释放不能只看 SYN 和 ACK，还要分析 seq 和 ack 确认号。王道P238.15
  - 已收到的数据量要同时看**起始序列号**和**确认号**。
  - 无论 IP 数据报在途中如何改变，其标识是不变的。若分片，则各个分片的标识相同。
  - 拥塞窗口的大小实际上是一个个 MSS 变化的，但要注意其中一些确认段是在同一时刻到达的。 王道P238.16 计算机网络P233
  - 注意发送前和发送后，确认前和确认后，可以进行小规模**类推分析**，以避免 $1$ 的偏差。 王道P238.16

## 应用层

### 网络应用模型

- 客户服务器模型（C/S）
	- 客户 Client
	- 服务器 Server 
- P2P 模型
	- 对等方 Peer

- 在传输层使用的协议 王道P206

### 域名系统（DNS）

- 采用客户服务器模型，协议运行于 UDP 之上，使用 53 号端口。

- 层次域名空间

	域名级别级别越高，写在越右边。

	- 国家顶级域名
	- 通用顶级域名
	- 基础结构域名（反向域名）

- 域名服务器

	是一个联机分布式的数据库系统，采用客户/服务器模型。

	- 根域名服务器

		管理顶级域

	- 顶级域名服务器

		管理在其注册的二级域。

	- 授权域名服务器（权限域名服务器）

		- 每台主机都必须在授权域名服务器处登记。
		- 授权域名服务器总能将其管辖的主机名转换为该主机的 IP 地址。

- 域名解析过程

	- 正向解析
	- 反向解析
	- 解析方式
		- 递归查询
		- 迭代和递归结合查询
			- 在主机到本地域名服务器之间是递归查询。
			- 在本地域名服务器到其它域名服务器之间是迭代查询。
	- 高速缓存
	- 注意
		- 主机，IP 地址，域名 之间都可以不是一对一关系。 王道P249.1
		- 最少最多查询次数（WWW 不算次数） 王道P150.9
		- 最少最多 RTT 王道P250.12
			- 本地局域网不计 RTT
			- 要考虑建立 TCP 时的 RTT
		- DNS 如果一次请求的报文丢失了，定时器计满而未收到回复，就会再请求一次。

### 文件传输协议（FTP）

- 采用客户/服务器模型，使用 TCP 的可靠传输。（默认的**控制端口**为 21）

- 一个 FTP 进程可同时为多个客户提供服务。

- 允许客户指明文件类型和格式，并允许具有存取权限。

- 能够支持异构网络，支持不同种类主机系统。

- 一个主进程，负责接收新的请求。

- 若干从属进程，负责处理单个请求。

- 连接分类

	使用两个并行的 TCP 连接。

	- 控制连接（端口 21）
		- 用来传输控制信息
		- 整个传输过程一直保持打开。
		- 控制信息与数据传送分离，称为**带外传送**。
	- 数据连接（端口 20）
		- 主动模式 PORT
			- 客户端发送命令，自己开放端口（主动开放端口）
			- 服务器接收命令并连接该端口发送数据。
		- 被动模式 PASV
			- 客户端发送命令，让服务器开放端口（被动开放端口）
			- 服务器开放端口后告知客户端。
			- 客户端连接服务器端口发送数据。

- 注意

	- 使用 FTP 修改文件，需要将文件传送到本地，再将副本传送回去。
	- 若使用**网络文件系统（NFS）**，允许远程打开一个文件，并在某个特定位置读写数据。
	- FTP 的匿名用户 ID：anonymous 。（其密码可以是任何字符串）

### 电子邮件

- 电子邮件系统构成

	- 用户代理
	- 邮件服务器
	- 使用的协议
- 简单邮件传输协议（SMTP）

	- 使用客户/服务器模式，使用 TCP， 端口号 25 。
	- 用于发送邮件方是客户，接收邮件方是服务器。
	- 用于用户向邮件服务器发送文件，邮件服务器与邮件服务器间传送文件。
	- 只能传送 ASCII 码。
	- HELO 命令
		- 建立连接，表明主机名。
	- MAIL 命令
		- 表明发件人（自身邮件地址）。
	- RCPT 命令
		- 向邮件服务器询问该用户地址是否存在。
	- DATA 命令
		- 表示开始传送数据。
	- QUIT 命令
		- 客户发送 QUIT 命令，请求释放连接。
- 邮局协议（POP）

	- 目前使用第三个版本，POP3 。
	- 使用客户/服务器模式，使用 TCP， 端口号 110 。
	- 只能传送 ASCII 码。

	- 用于用户从邮件服务器提取邮件。
	- 接收方的用户代理上运行 POP 客户程序。
	- 邮件服务器上运行 POP 服务器程序。
	- POP 不对密码进行加密。
- 因特网报文存取协议（IMAP）

	- 用于用户从邮件服务器提取邮件。
	- 比 POP 协议提供更多文件控制功能。
- 基于万维网的电子邮件

	- Hotmail、Gmail 等。
	- 这些协议的用户浏览器与邮件服务器之间的发送或接收使用 HTTP，
	- 只在不同邮件服务器间传送邮件时才适用 SMTP。
- 电子邮件格式

	- 首部
	- 主体
- 多用途网际邮件扩充（MIME）

	- 定义了传送非 ASCII 码的编码规则。
	- 可以在 SMTP 和 POP3 上使用。
- 注意

	- SMTP
		- 用于发送邮件方是客户，接收邮件方是服务器。
		- 用于用户向邮件服务器发送文件，邮件服务器与邮件服务器间传送文件。
	- POP
		- 用于用户从邮件服务器提取邮件。
	- IMAP
		- 用于用户从邮件服务器提取邮件。
	- 注意，不能明确是用户发送给服务器还是服务器发送给用户，就查看端口号。 王道P267.3

### 万维网（WWW）

- 万维网的内核部分组成
	- 统一资源定位符（URL）
	- 超文本传输协议（HTTP）
	- 超文本标记语言（HTML）
- **万维网**是无数个网络站点和网页的集合，构成了**因特网**最主要的部分（因特网还包括电子邮件、Usenet和新闻组等）。

### 超文本传输协议（HTTP）

- 基本概念	

	- 默认监听端口 $80$ 。
	- 使用 TCP。
	- 注意，HTTP 本身是无连接的，无需建立 HTTP 连接，但 TCP 是要建立连接的。
	- HTTP 是无状态的，通常使用 Cookie 来跟踪用户活动。

- 连接类型

	- 非持久连接

		- 每个网页元素对象都需要单独建立一个 TCP 连接。
		- 第三次握手的报文捎带客户对文档的请求。

	- 持久连接

		发送响应后，仍然保持连接。

		- 非流水线方式

			客户在收到一个响应后，才能发出下一个请求。

		- 流水线方式

	- 注意

		- HTTP/1.0 只支持非持久连接
		- HTTP/1.1 都支持，当 Connection 字段 王道P169.12
			- 为 Close，表示非持续连接。
			- 为 Keep-alive，表示持续连接
		- 传输万维网文档时，需要先传送一个基本 HTTP 文档，然后是里面的各个对象。

- 报文结构 王道P264

	HTTP 的报文是 ASCII 码串。

	- 请求报文
		- 请求报文方法
			- GET
			- HEAD
			- POST
			- CONNECT
	- 响应报文
